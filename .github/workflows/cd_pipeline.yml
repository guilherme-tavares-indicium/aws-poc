name: Build and Publish Docker Image

on:
  push:
    branches:
      - master

env:
  REGION: us-east-1
  ACCOUNT_ID: 196029031078

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/iam-github-oidc
          role-session-name: "GitHubActions"
          aws-region: ${{ env.REGION }}

      - name: Get GitHub repository name
        id: repo_name
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "::set-output name=name::$(basename ${GITHUB_REPOSITORY,,}_ecr | sed -E 's/[^a-z0-9._-]+/-/g; s/^-+|-+$//g')"
        shell: bash

        

      - name: Login to ECR
        id: login
        run: |
          aws ecr get-login-password --region ${{ env.REGION }} | docker login --username AWS --password-stdin ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.REGION }}.amazonaws.com

      - name: Check if ECR repo exists and create if not
        env:
          AWS_DEFAULT_REGION: ${{ env.REGION }}
        run: |
          repo_name="${{ steps.repo_name.outputs.name }}"
          if aws ecr describe-repositories --region ${{ env.REGION }} --repository-names "$repo_name" > /dev/null 2>&1; then
            echo "ECR repository exists"
          else
            echo "Creating ECR repository"
            aws ecr create-repository --region ${{ env.REGION }} --repository-name "$repo_name"
          fi

      - name: Get ECR repo URL
        id: ecr_url
        env:
          AWS_DEFAULT_REGION: ${{ env.REGION }}
        run: |
          repo_name="${{ steps.repo_name.outputs.name }}"
          echo "::set-output name=url::$(aws ecr describe-repositories --region ${{ env.REGION }} --repository-names "$repo_name" --query 'repositories[0].repositoryUri' --output text)"


      - name: Build and publish Docker image
        run: |
          cd etl_scripts
          docker build -t etl_image .
          repo_name="${{ steps.repo_name.outputs.name }}"
          docker tag etl_image ${{ steps.ecr_url.outputs.url }}:latest
          docker push ${{ steps.ecr_url.outputs.url }}:latest

